<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kb2midi</title>
    <script>
        (function () {
            try {
                const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
                if (media) {
                    document.documentElement.dataset.theme = media.matches ? 'dark' : 'light';
                }
            } catch {}
        })();
    </script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="splash" class="splash" aria-label="Loading">
        <div class="splash-content">
            <div class="splash-title">üéπ kb2midi</div>
            <div class="splash-subtitle">Loading‚Ä¶</div>
            <div class="splash-spinner" aria-hidden="true"></div>
        </div>
    </div>
    <div class="header">
        <h1>üéπ kb2midi</h1>
        <div class="status" id="status">Ready to play!</div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="velocity">Velocity</label>
            <input type="range" id="velocity" min="1" max="127" value="80" tabindex="-1">
            <span id="velocity-value">80</span>
        </div>
        
        <div class="control-group">
            <label for="midi-channel">MIDI Channel</label>
            <select id="midi-channel" tabindex="-1">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="midi-note-input">Note Input</label>
            <select id="midi-note-input" tabindex="-1">
                <option value="keyboard">QWERTY Keyboard</option>
            </select>
        </div>

        <div class="control-group">
            <label for="clock-source">Clock Source</label>
            <select id="clock-source" tabindex="-1">
                <option value="external">External MIDI</option>
                <option value="internal">Internal Master</option>
                <option value="off">Off</option>
            </select>
        </div>

        <div class="control-group" id="external-clock-controls">
            <label for="midi-clock-input">Clock Input</label>
            <select id="midi-clock-input" tabindex="-1">
                <option value="auto">Auto (Best)</option>
            </select>
        </div>

        <div class="control-group" id="internal-clock-controls" style="display: none;">
            <label for="internal-bpm">Internal BPM</label>
            <div style="display:flex; gap:8px; align-items:center;">
                <input type="number" id="internal-bpm" min="20" max="300" value="120" tabindex="-1" style="width: 70px;">
                <button id="internal-clock-toggle" tabindex="-1">Start</button>
            </div>
        </div>

        <div class="control-group">
            <label>Wheels</label>
            <div style="display:flex; gap:8px; justify-content:center;">
                <div id="mod-indicator" class="wheel-indicator" title="Hold ArrowUp">Mod</div>
                <div id="pitch-indicator" class="wheel-indicator" title="Hold ArrowDown">Pitch</div>
            </div>
        </div>
        
        <div class="control-group">
            <label>Octave</label>
            <div style="display:flex; gap:8px; justify-content:center;">
                <div id="octave-down-indicator" class="wheel-indicator" title="Hold ArrowLeft">‚Üì Oct</div>
                <div id="octave-up-indicator" class="wheel-indicator" title="Hold ArrowRight">‚Üë Oct</div>
            </div>
        </div>
        
        <div class="control-group">
            <label>Keyboard Layout</label>
            <select id="layout-select" tabindex="-1">
                <option value="expanded">Expanded</option>
                <option value="simple">Simple</option>
            </select>
        </div>

        <div class="control-group">
            <label>Scale Filter</label>
            <button id="scale-filter-toggle" tabindex="-1">Enable Scale Filter</button>
        </div>

        <div class="scale-filter-controls" id="scale-filter-controls" style="display: none;">
            <div class="control-group">
                <label for="scale-root">Root Note</label>
                <select id="scale-root" tabindex="-1">
                    <option value="0">C</option>
                    <option value="1">C#</option>
                    <option value="2">D</option>
                    <option value="3">D#</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F#</option>
                    <option value="7">G</option>
                    <option value="8">G#</option>
                    <option value="9">A</option>
                    <option value="10">A#</option>
                    <option value="11">B</option>
                </select>
            </div>
            <div class="control-group">
                <label for="scale-type">Scale Type</label>
                <select id="scale-type" tabindex="-1">
                    <option value="chromatic" selected>Chromatic (All Notes)</option>
                    <option value="major">Major (Ionian)</option>
                    <option value="minor">Natural Minor (Aeolian)</option>
                    <option value="harmonicMinor">Harmonic Minor</option>
                    <option value="melodicMinor">Melodic Minor</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="locrian">Locrian</option>
                    <option value="pentatonicMajor">Pentatonic Major</option>
                    <option value="pentatonicMinor">Pentatonic Minor</option>
                    <option value="blues">Blues</option>
                    <option value="wholeTone">Whole Tone</option>
                    <option value="diminished">Diminished</option>
                    <option value="augmented">Augmented</option>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Actions</label>
            <button id="panic-button" tabindex="-1">Stop All Notes</button>
            <button id="arpeggiator-toggle" tabindex="-1">Enable Arpeggiator</button>
        </div>
        
        <div class="arpeggiator-controls" id="arpeggiator-controls" style="display: none;">
            <!-- Row 1: Pattern -->
            <div class="arp-row">
                <div class="control-group">
                    <label>Pattern</label>
                    <div class="btn-group" id="arp-pattern" data-value="up">
                        <button type="button" class="btn-group-item active" data-value="up" tabindex="-1">Up</button>
                        <button type="button" class="btn-group-item" data-value="down" tabindex="-1">Down</button>
                        <button type="button" class="btn-group-item" data-value="up-down" tabindex="-1">U-D</button>
                        <button type="button" class="btn-group-item" data-value="down-up" tabindex="-1">D-U</button>
                        <button type="button" class="btn-group-item" data-value="random" tabindex="-1">Rnd</button>
                        <button type="button" class="btn-group-item" data-value="chord" tabindex="-1">Chrd</button>
                        <button type="button" class="btn-group-item" data-value="stacked-chord" tabindex="-1">Stk</button>
                        <button type="button" class="btn-group-item" data-value="timeline" tabindex="-1">Time</button>
                    </div>
                </div>
            </div>
            <!-- Row 2: Division + Timing -->
            <div class="arp-row">
                <div class="control-group">
                    <label>Division</label>
                    <div class="btn-group" id="arp-division" data-value="4">
                        <button type="button" class="btn-group-item" data-value="1" tabindex="-1">1</button>
                        <button type="button" class="btn-group-item" data-value="2" tabindex="-1">1/2</button>
                        <button type="button" class="btn-group-item active" data-value="4" tabindex="-1">1/4</button>
                        <button type="button" class="btn-group-item" data-value="8" tabindex="-1">1/8</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Timing</label>
                    <div class="btn-group" id="arp-timing-type" data-value="straight">
                        <button type="button" class="btn-group-item active" data-value="straight" tabindex="-1">Str</button>
                        <button type="button" class="btn-group-item" data-value="swing" tabindex="-1">Swng</button>
                        <button type="button" class="btn-group-item" data-value="shuffle" tabindex="-1">Shfl</button>
                        <button type="button" class="btn-group-item" data-value="dotted" tabindex="-1">Dot</button>
                    </div>
                </div>
            </div>
            <!-- Row 3: Accent + Ratchet -->
            <div class="arp-row">
                <div class="control-group">
                    <label>Accent</label>
                    <div class="btn-group" id="arp-accent" data-value="none">
                        <button type="button" class="btn-group-item active" data-value="none" tabindex="-1">None</button>
                        <button type="button" class="btn-group-item" data-value="downbeats" tabindex="-1">Down</button>
                        <button type="button" class="btn-group-item" data-value="offbeats" tabindex="-1">Up</button>
                        <button type="button" class="btn-group-item" data-value="every-3rd" tabindex="-1">3rd</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Ratchet</label>
                    <div class="btn-group" id="arp-ratchet" data-value="1">
                        <button type="button" class="btn-group-item active" data-value="1" tabindex="-1">Off</button>
                        <button type="button" class="btn-group-item" data-value="2" tabindex="-1">2x</button>
                        <button type="button" class="btn-group-item" data-value="3" tabindex="-1">3x</button>
                        <button type="button" class="btn-group-item" data-value="4" tabindex="-1">4x</button>
                    </div>
                </div>
            </div>
            <!-- Row 4: Gate + Probability sliders -->
            <div class="arp-row">
                <div class="control-group">
                    <label id="arp-gate-label" for="arp-gate">Gate</label>
                    <input type="range" id="arp-gate" min="0" max="100" value="50" tabindex="-1">
                    <span id="arp-gate-value">50%</span>
                </div>
                <div class="control-group">
                    <label>Probability</label>
                    <input type="range" id="arp-probability" min="0" max="100" value="100" tabindex="-1">
                    <span id="arp-probability-value">100%</span>
                </div>
            </div>
            <!-- Row 5: Checkboxes -->
            <div class="arp-row">
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="arp-humanize" tabindex="-1">
                        Humanize
                    </label>
                </div>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="arp-humanize-velocity" tabindex="-1">
                        Humanize Velocity
                    </label>
                </div>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="latch-mode" tabindex="-1">
                        Latch Mode
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="piano-container">
        <div class="piano" id="piano"></div>
    </div>

    <div class="keyboard-mapping" id="keyboard-mapping">
        <!-- Content dynamically generated -->
    </div>
    
    <div class="octave-display">
        Octave: <span id="current-octave">4</span>
    </div>
    
    <div id="clock-status" class="clock-status">
        üî¥ No Clock Sync
        <div id="beat-indicator" class="beat-indicator"></div>
    </div>

    <div class="instructions">
        <h3>Setup Instructions</h3>
        <p><strong>‚ö†Ô∏è Important:</strong> The Web MIDI API in browsers can't create new MIDI devices that other software can see. We need to create a virtual MIDI port first.</p>
        
        <h4>Step 1: Create a Virtual MIDI Port</h4>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h5>üì± macOS (Sonoma/Ventura/Monterey/Big Sur):</h5>
            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Open <strong>Audio MIDI Setup</strong> (Applications > Utilities > Audio MIDI Setup)</li>
                <li>Go to <strong>Window > Show MIDI Studio</strong></li>
                <li>Double-click the <strong>IAC Driver</strong> icon</li>
                <li>Check <strong>"Device is online"</strong></li>
                <li>You should see "Bus 1" - this creates a virtual MIDI port</li>
                <li>Optionally, click the <strong>+</strong> to add more ports or rename them</li>
            </ol>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h5>ü™ü Windows 11:</h5>
            <p><strong>Option A - loopMIDI (Recommended):</strong></p>
            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Download <strong>loopMIDI</strong> from <code>tobias-erichsen.de/software/loopmidi.html</code></li>
                <li>Install and run loopMIDI</li>
                <li>Click the <strong>"+"</strong> button to create a new virtual MIDI port</li>
                <li>Name it something like "kb2midi"</li>
                <li>The port will appear in your DAW's MIDI inputs</li>
            </ol>
            
            <p><strong>Option B - MIDI-OX + MIDI Yoke:</strong></p>
            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Download <strong>MIDI Yoke</strong> from <code>midiox.com</code></li>
                <li>Install MIDI Yoke (creates virtual MIDI cables)</li>
                <li>Download and install <strong>MIDI-OX</strong></li>
                <li>Use "Out To MIDI Yoke: 1" as your virtual port</li>
            </ol>
            
            <p><strong>Option C - Built-in (Windows 11 22H2+):</strong></p>
            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Go to <strong>Settings > Bluetooth & devices > More devices and printer settings</strong></li>
                <li>Right-click and select <strong>"Add a device"</strong></li>
                <li>Look for MIDI device options (availability varies)</li>
            </ol>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h5>üêß Linux (Ubuntu/Debian):</h5>
            <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Install ALSA utilities: <code>sudo apt install alsa-utils</code></li>
                <li>Create virtual MIDI port: <code>sudo modprobe snd-virmidi</code></li>
                <li>Or use <strong>QjackCtl</strong> for more advanced MIDI routing</li>
                <li>Install via: <code>sudo apt install qjackctl</code></li>
            </ol>
        </div>
        
        <h4>Step 2: Use the Controller</h4>
        <p><strong>Layout Options:</strong> Use the dropdown to switch between Simple and Expanded layouts</p>
        <p><strong>Simple Layout:</strong> A S D F G H J K L (white keys), W E T Y U O P (black keys)</p>
        <p><strong>Expanded Layout:</strong> Z-/ (base octave), Q-P (upper octave), number row for sharps</p>
        <p><strong>Octave:</strong> Hold ArrowLeft and ArrowRight to change octave</p>
        <p><strong>Sustain:</strong> Hold SPACE</p>
        <p><strong>Click "Connect MIDI" to enable MIDI output</strong></p>
        <p><strong>Click on piano keys or use your computer keyboard to play!</strong></p>
        
        <h4>Step 3: Connect to Your DAW</h4>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <p><strong>Logic Pro/GarageBand:</strong> Create new Software Instrument track, select the virtual MIDI port as input</p>
            <p><strong>Ableton Live:</strong> Go to Preferences > Link/Tempo/MIDI > MIDI Ports, enable the virtual port</p>
            <p><strong>FL Studio:</strong> Options > MIDI Settings, enable the virtual MIDI port in Input</p>
            <p><strong>Reaper:</strong> Options > Preferences > MIDI Devices, enable the virtual port</p>
        </div>
    </div>
    
    <div id="midi-help" style="display: none;">
        <p class="error">‚ö†Ô∏è Web MIDI API not available. Please use Chrome, Edge, or Safari.</p>
    </div>

    <script type="module" src="/src/main.ts"></script>
</body>
</html>
